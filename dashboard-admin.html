<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Suite | Noshahi Panda Central</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --brand-red: #D70F64;
            --brand-dark: #0f172a;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f1f5f9;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--brand-dark);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            padding: 2rem;
            z-index: 1000;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2.5rem;
        }

        .nav-link-admin {
            color: rgba(255, 255, 255, 0.6);
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
            margin-bottom: 0.3rem;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .nav-link-admin:hover,
        .nav-link-admin.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link-admin.active {
            background: var(--brand-red);
        }

        .nav-category {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.3);
            margin: 1.5rem 0 0.5rem 1rem;
            font-weight: 700;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .table-premium {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .table-premium thead {
            background: #f8fafc;
        }

        .review-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--brand-red);
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            height: 400px;
        }

        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .balance-card-corp {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
        }

        /* Modern Toggle Switch */
        .status-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .status-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-round {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }

        .slider-round:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider-round {
            background-color: #10b981;
        }

        input:checked+.slider-round:before {
            transform: translateX(22px);
        }

        input:disabled+.slider-round {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-suspended {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-brand-red p-2 rounded-3 me-2" style="background: var(--brand-red)">
                <i class="fa-solid fa-crown fa-lg"></i>
            </div>
            <span class="h5 fw-bold mb-0">Central Master</span>
        </div>

        <nav>
            <div class="nav-category">Main</div>
            <button class="nav-link-admin active" data-section="section-analytics"><i
                    class="fa-solid fa-chart-line"></i> Analytics</button>
            <button class="nav-link-admin" data-section="section-orders"><i class="fa-solid fa-bag-shopping"></i>
                Orders</button>
            <button class="nav-link-admin" data-section="section-restaurants"><i class="fa-solid fa-utensils"></i>
                Restaurants</button>
            <button class="nav-link-admin" data-section="section-riders"><i class="fa-solid fa-motorcycle"></i> Riders
                fleet</button>
            <button class="nav-link-admin" data-section="section-reviews"><i class="fa-solid fa-star"></i> Reviews
                Feed</button>

        </nav>

        <div class="mt-auto pt-4">
            <a href="index.html" class="nav-link-admin text-danger"><i class="fa-solid fa-arrow-right-from-bracket"></i>
                Logout</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="fw-bold h2 mb-1" id="page-title">Business Overview</h1>
                <p class="text-muted mb-0" id="current-date"></p>
            </div>
            <button class="btn btn-dark px-4 rounded-pill" onclick="location.reload()">
                <i class="fa-solid fa-rotate me-2"></i> Refresh
            </button>
        </header>

        <!-- SECTION: ANALYTICS -->
        <section id="section-analytics" class="dashboard-section active">
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-primary bg-opacity-10 text-primary"><i
                                    class="fa-solid fa-money-bill-trend-up"></i></div>
                            <span class="text-success small fw-bold">+12% <i class="fa-solid fa-arrow-up"></i></span>
                        </div>
                        <h3 class="fw-bold mb-1" id="total-revenue">Rs. 0</h3>
                        <p class="text-muted small mb-0">Total Platform Sales</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-danger bg-opacity-10 text-danger"><i
                                    class="fa-solid fa-bag-shopping"></i></div>
                            <span class="text-success small fw-bold">+8% <i class="fa-solid fa-arrow-up"></i></span>
                        </div>
                        <h3 class="fw-bold mb-1" id="total-orders">0</h3>
                        <p class="text-muted small mb-0">Platform Orders</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-warning bg-opacity-10 text-warning"><i class="fa-solid fa-star"></i>
                            </div>
                            <span class="text-info small fw-bold">4.8 Avg</span>
                        </div>
                        <h3 class="fw-bold mb-1" id="total-reviews">0</h3>
                        <p class="text-muted small mb-0">Global Reviews</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-success bg-opacity-10 text-success"><i
                                    class="fa-solid fa-building"></i></div>
                            <span class="text-muted small">Active</span>
                        </div>
                        <h3 class="fw-bold mb-1" id="total-partners">0</h3>
                        <p class="text-muted small mb-0">Network Partners</p>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-lg-8">
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container overflow-auto" id="recent-reviews-mini">
                        <h5 class="fw-bold mb-4">Live Feedback</h5>
                        <div id="review-list"><!-- Dynamic --></div>
                    </div>
                </div>
            </div>

            <h5 class="fw-bold mb-4">Master Transaction Ledger</h5>
            <div class="table-premium">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Order ID</th>
                            <th>Restaurant</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th class="text-end pe-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list"></tbody>
                </table>
            </div>
        </section>



        <!-- SECTION: RESTAURANTS -->
        <section id="section-restaurants" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Restaurant Partnerships</h4>
                <button class="btn btn-brand-red rounded-pill px-4" data-bs-toggle="modal"
                    data-bs-target="#addResModal">
                    <i class="fa-solid fa-plus me-2"></i> Onboard Restaurant
                </button>
            </div>
            <div class="table-premium">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Restaurant</th>
                            <th>Owner</th>
                            <th>Cuisine</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Manage Status</th>
                        </tr>
                    </thead>
                    <tbody id="master-res-list"></tbody>
                </table>
            </div>
        </section>

        <!-- SECTION: RIDERS -->
        <section id="section-riders" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Rider Logistics Fleet</h4>
                <button class="btn btn-dark rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addRiderModal">
                    <i class="fa-solid fa-person-biking me-2"></i> Hire New Rider
                </button>
            </div>
            <div class="table-premium">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Rider</th>
                            <th>Vehicle</th>
                            <th>Salary</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Manage Status</th>
                        </tr>
                    </thead>
                    <tbody id="master-rider-list"></tbody>
                </table>
            </div>
        </section>

        <!-- SECTION: ORDERS -->
        <section id="section-orders" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Platform Orders Management</h4>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control rounded-pill px-3" placeholder="Search orders..."
                        style="width: 250px;">
                </div>
            </div>
            <div class="table-premium">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Order ID</th>
                            <th>Restaurant</th>
                            <th>Date & Time</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="master-order-list"></tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- MODALS -->
    <!-- Add Restaurant Modal -->
    <div class="modal fade" id="addResModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="bg-brand-red p-4 text-white">
                    <h5 class="fw-bold mb-0">Onboard New Restaurant</h5>
                </div>
                <form id="add-res-form" class="p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Restaurant Name</label>
                        <input type="text" class="form-control" name="resName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Owner Name</label>
                        <input type="text" class="form-control" name="ownerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Cuisine Type</label>
                        <select class="form-select" name="cuisine">
                            <option>Fast Food</option>
                            <option>Desi</option>
                            <option>Chinese</option>
                            <option>Italian</option>
                        </select>
                    </div>
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-brand-red rounded-pill px-4 fw-bold">Save Partner</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Rider Modal -->
    <div class="modal fade" id="addRiderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="bg-dark p-4 text-white">
                    <h5 class="fw-bold mb-0">Contract New Rider</h5>
                </div>
                <form id="add-rider-form" class="p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Full Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Vehicle Type</label>
                        <select class="form-select" name="vehicle">
                            <option>Motorbike</option>
                            <option>Bicycle</option>
                            <option>Car</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Monthly Salary (Rs)</label>
                        <input type="number" class="form-control" name="salary" value="25000">
                    </div>
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-dark rounded-pill px-4 fw-bold">Add to Fleet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Partner Profile Detail Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Entity Profile Audit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="profile-detail-content">
                    <!-- Dynamic Profile Info -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Date
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // TAB SWITCHING LOGIC
            const navLinks = document.querySelectorAll('.nav-link-admin');
            const sections = document.querySelectorAll('.dashboard-section');
            const pageTitle = document.getElementById('page-title');

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const target = link.getAttribute('data-section');
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(target).classList.add('active');
                    pageTitle.innerText = link.innerText.trim();

                    if (target === 'section-restaurants') renderRestaurants();
                    if (target === 'section-riders') renderRiders();
                    if (target === 'section-orders') renderOrders();
                });
            });

            // DATA HANDLING
            function getStore(key) { return JSON.parse(localStorage.getItem(key) || '[]'); }
            function setStore(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

            function renderAll() {
                const reviews = getStore('noshahi_reviews');
                const sales = getStore('noshahi_sales_data');
                const restaurants = getStore('noshahi_all_restaurants');
                const riders = getStore('noshahi_all_riders');

                // Update Stats
                const totalRevenue = sales.reduce((acc, sale) => acc + sale.amount, 0);
                document.getElementById('total-revenue').innerText = `Rs. ${totalRevenue.toLocaleString()}`;
                document.getElementById('total-orders').innerText = sales.length;
                document.getElementById('total-reviews').innerText = reviews.length;
                document.getElementById('total-partners').innerText = restaurants.length + riders.length;

                // Mini Reviews
                const reviewList = document.getElementById('review-list');
                if (reviews.length > 0) {
                    reviewList.innerHTML = reviews.slice(-5).reverse().map(rev => `
                        <div class="review-card">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small fw-bold">Order #${rev.orderId || 'NP-000'}</span>
                                <span class="text-warning small">${Array(rev.rating).fill('<i class="fa-solid fa-star"></i>').join('')}</span>
                            </div>
                            <p class="small text-muted mb-0">"${rev.comment || 'Safe!'}"</p>
                        </div>
                    `).join('');
                }

                // Transactions
                const transList = document.getElementById('transaction-list');
                if (sales.length > 0) {
                    transList.innerHTML = sales.slice().reverse().map(sale => `
                        <tr>
                            <td class="ps-4 fw-bold">#NP-${sale.id.toString().slice(-4)}</td>
                            <td>${sale.restaurant}</td>
                            <td>${new Date(sale.date).toLocaleDateString()}</td>
                            <td class="fw-bold text-brand-red">Rs. ${sale.amount}</td>
                            <td class="text-end pe-4"><span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Delivered</span></td>
                        </tr>
                    `).join('');
                } else {
                    transList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No transactions found</td></tr>';
                }
            }

            window.renderOrders = () => {
                const data = getStore('noshahi_sales_data');
                const list = document.getElementById('master-order-list');
                if (data.length > 0) {
                    list.innerHTML = data.slice().reverse().map((sale, i) => `
                        <tr>
                            <td class="ps-4 fw-bold">#NP-${sale.id.toString().slice(-4)}</td>
                            <td>${sale.restaurant}</td>
                            <td>${new Date(sale.date).toLocaleString()}</td>
                            <td class="fw-bold text-brand-red">Rs. ${sale.amount}</td>
                            <td><span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Delivered</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-light border-0 me-1" onclick="Swal.fire({ title: 'Order Details', text: 'Viewing order details...', icon: 'info', confirmButtonColor: '#D70F64' })">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No orders found on the platform</td></tr>';
                }
            };

            window.renderRestaurants = () => {
                const data = getStore('noshahi_all_restaurants');
                const apps = getStore('noshahi_seller_applications');

                document.getElementById('master-res-list').innerHTML = data.slice().reverse().map((res, i) => {
                    const originalIndex = data.length - 1 - i;

                    // Find owner if undefined
                    let ownerName = res.owner;
                    if (!ownerName || ownerName === 'undefined') {
                        const app = apps.find(a => a.id === res.id);
                        if (app) ownerName = `${app.owner.firstName} ${app.owner.lastName}`;
                        else ownerName = "N/A";
                    }

                    const isActive = res.status === 'Approved' || res.status === 'Active';
                    const isPending = res.status === 'Pending';
                    const isSuspended = res.status === 'Suspended';

                    let statusBadge = '';
                    if (isPending) statusBadge = '<span class="badge badge-pending rounded-pill px-2">Pending</span>';
                    else if (isActive) statusBadge = '<span class="badge badge-active rounded-pill px-2">Active</span>';
                    else if (isSuspended) statusBadge = '<span class="badge badge-suspended rounded-pill px-2">Suspended</span>';

                    const toggleHtml = `
                        <label class="status-switch">
                            <input type="checkbox" ${isActive ? 'checked' : ''} onchange="handleResStatusToggle(${res.id}, this.checked)">
                            <span class="slider-round"></span>
                        </label>
                    `;

                    return `
                        <tr>
                            <td class="ps-4"><strong>${res.name}</strong></td>
                            <td>${ownerName}</td>
                            <td>${res.cuisine}</td>
                            <td>${statusBadge}</td>
                            <td class="text-end pe-4">
                                <div class="d-flex align-items-center justify-content-end gap-3">
                                    <span class="small fw-bold text-muted">${isActive ? 'Active' : (isPending ? 'Approve' : 'Suspended')}</span>
                                    ${toggleHtml}
                                    <button class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="deleteItem('noshahi_all_restaurants', ${originalIndex})"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            window.handleResStatusToggle = (id, isChecked) => {
                let restaurants = getStore('noshahi_all_restaurants');
                let apps = getStore('noshahi_seller_applications');
                const resIndex = restaurants.findIndex(r => r.id === id);
                const appIndex = apps.findIndex(a => a.id === id);

                if (resIndex === -1) return;
                const restaurant = restaurants[resIndex];

                if (isChecked) {
                    if (restaurant.status === 'Pending') {
                        Swal.fire({
                            title: 'Accept Application?',
                            text: `Are you sure you want to approve "${restaurant.name}"?`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#10b981',
                            confirmButtonText: 'Yes, Approve'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                restaurants[resIndex].status = 'Approved';
                                if (appIndex !== -1) {
                                    apps[appIndex].status = 'Approved';
                                    if (!apps[appIndex].approvedEmail) {
                                        apps[appIndex].approvedEmail = apps[appIndex].owner.email;
                                        apps[appIndex].approvedPassword = 'PANDA-' + Math.floor(1000 + Math.random() * 9000);

                                        let sellerAuth = getStore('noshahi_seller_auth');
                                        sellerAuth.push({
                                            email: apps[appIndex].approvedEmail,
                                            password: apps[appIndex].approvedPassword,
                                            restaurantId: id
                                        });
                                        setStore('noshahi_seller_auth', sellerAuth);
                                    }
                                }
                                setStore('noshahi_all_restaurants', restaurants);
                                setStore('noshahi_seller_applications', apps);
                                Swal.fire('Restaurant Activated', '✅ Restaurant activated successfully!', 'success');
                                renderRestaurants();
                                renderAll();
                            } else {
                                renderRestaurants();
                            }
                        });
                        return;
                    } else {
                        restaurants[resIndex].status = 'Approved';
                        if (appIndex !== -1) apps[appIndex].status = 'Approved';
                    }
                } else {
                    Swal.fire({
                        title: 'Suspend Restaurant?',
                        text: `Are you sure you want to SUSPEND "${restaurant.name}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#ef4444'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            restaurants[resIndex].status = 'Suspended';
                            if (appIndex !== -1) apps[appIndex].status = 'Suspended';
                            setStore('noshahi_all_restaurants', restaurants);
                            setStore('noshahi_seller_applications', apps);
                            Swal.fire('Suspended', 'Restaurant has been suspended.', 'info');
                            renderRestaurants();
                            renderAll();
                        } else {
                            renderRestaurants();
                        }
                    });
                    return;
                }

                setStore('noshahi_all_restaurants', restaurants);
                setStore('noshahi_seller_applications', apps);
                renderRestaurants();
                renderAll();
            };

            window.renderRiders = () => {
                const data = getStore('noshahi_all_riders');
                document.getElementById('master-rider-list').innerHTML = data.slice().reverse().map((r, i) => {
                    const originalIndex = data.length - 1 - i;
                    const isActive = r.status === 'Active' || r.status === 'Approved' || !r.status;
                    const isSuspended = r.status === 'Suspended' || r.status === 'Inactive';

                    const statusBadge = isActive
                        ? '<span class="badge badge-active rounded-pill px-2">Active</span>'
                        : '<span class="badge badge-suspended rounded-pill px-2">Suspended</span>';

                    const toggleHtml = `
                        <label class="status-switch">
                            <input type="checkbox" ${isActive ? 'checked' : ''} onchange="handleRiderStatusToggle(${r.id}, this.checked)">
                            <span class="slider-round"></span>
                        </label>
                    `;

                    return `
                        <tr>
                            <td class="ps-4"><strong>${r.name}</strong></td>
                            <td>${r.vehicle}</td>
                            <td>Rs. ${parseInt(r.salary || 25000).toLocaleString()}</td>
                            <td>${statusBadge}</td>
                            <td class="text-end pe-4">
                                <div class="d-flex align-items-center justify-content-end gap-3">
                                    <span class="small fw-bold text-muted">${isActive ? 'Active' : 'Suspended'}</span>
                                    ${toggleHtml}
                                    <button class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="deleteItem('noshahi_all_riders', ${originalIndex})"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            window.handleRiderStatusToggle = (id, isChecked) => {
                let riders = getStore('noshahi_all_riders');
                const riderIndex = riders.findIndex(r => r.id === id);

                if (riderIndex === -1) return;

                const rider = riders[riderIndex];
                const newStatus = isChecked ? 'Active' : 'Suspended';

                if (!isChecked) {
                    Swal.fire({
                        title: 'Suspend Rider?',
                        text: `Are you sure you want to SUSPEND rider "${rider.name}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#ef4444'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            riders[riderIndex].status = newStatus;
                            setStore('noshahi_all_riders', riders);
                            Swal.fire('Suspended', `Rider "${rider.name}" is now suspended!`, 'info');
                            renderRiders();
                            renderAll();
                        } else {
                            renderRiders();
                        }
                    });
                } else {
                    riders[riderIndex].status = newStatus;
                    setStore('noshahi_all_riders', riders);
                    Swal.fire('Activated', `✅ Rider "${rider.name}" is now active!`, 'success');
                    renderRiders();
                    renderAll();
                }
            };

            window.viewProfile = (type, idx) => {
                const data = getStore(type === 'restaurant' ? 'noshahi_all_restaurants' : 'noshahi_all_riders');
                const item = data[idx];
                const content = document.getElementById('profile-detail-content');

                if (type === 'restaurant') {
                    content.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="bg-brand-red text-white d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width:70px;height:70px">
                                <i class="fa-solid fa-utensils fa-2x"></i>
                            </div>
                            <h4 class="fw-bold mb-0">${item.name}</h4>
                            <p class="text-muted small">${item.cuisine} Kitchen</p>
                        </div>
                        <div class="p-3 bg-light rounded-3">
                            <div class="row g-3">
                                <div class="col-6"><p class="small text-muted mb-0">Owner</p><h6 class="fw-bold">${item.owner}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Status</p><h6 class="fw-bold text-success">${item.status || 'Verified'}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Member Since</p><h6 class="fw-bold">${item.date || 'Jan 2024'}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Performance</p><h6 class="fw-bold text-warning"><i class="fa-solid fa-star"></i> 4.5/5</h6></div>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="bg-dark text-white d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width:70px;height:70px">
                                <i class="fa-solid fa-motorcycle fa-2x"></i>
                            </div>
                            <h4 class="fw-bold mb-0">${item.name}</h4>
                            <p class="text-muted small">Panda Logistics Partner</p>
                        </div>
                        <div class="p-3 bg-light rounded-3">
                            <div class="row g-3">
                                <div class="col-6"><p class="small text-muted mb-0">Vehicle</p><h6 class="fw-bold">${item.vehicle}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Salary/Mo</p><h6 class="fw-bold text-primary">Rs. ${parseInt(item.salary).toLocaleString()}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Hired On</p><h6 class="fw-bold">${item.date || 'Feb 2024'}</h6></div>
                                <div class="col-6"><p class="small text-muted mb-0">Rider Rating</p><h6 class="fw-bold text-warning"><i class="fa-solid fa-star"></i> ${item.rating || '5.0'}</h6></div>
                            </div>
                        </div>
                    `;
                }
                new bootstrap.Modal(document.getElementById('profileModal')).show();
            };

            window.deleteItem = (key, idx) => {
                if (!confirm('Are you sure you want to terminate this partnership?')) return;
                let data = getStore(key);
                data.splice(idx, 1);
                setStore(key, data);
                renderAll();
                if (key.includes('res')) renderRestaurants(); else renderRiders();
            };

            // Form Submissions
            document.getElementById('add-res-form').onsubmit = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = getStore('noshahi_all_restaurants');
                data.push({ name: fd.get('resName'), owner: fd.get('ownerName'), cuisine: fd.get('cuisine'), status: 'Active', date: new Date().toLocaleDateString() });
                setStore('noshahi_all_restaurants', data);
                bootstrap.Modal.getInstance(document.getElementById('addResModal')).hide();
                renderRestaurants(); e.target.reset();
            };

            document.getElementById('add-rider-form').onsubmit = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = getStore('noshahi_all_riders');
                data.push({ name: fd.get('name'), vehicle: fd.get('vehicle'), salary: fd.get('salary'), rating: '5.0', status: 'Active', date: new Date().toLocaleDateString() });
                setStore('noshahi_all_riders', data);
                bootstrap.Modal.getInstance(document.getElementById('addRiderModal')).hide();
                renderRiders(); e.target.reset();
            };

            renderAll();
            // Charts
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sales (Rs)',
                        data: [12000, 19000, 15000, 25000, 22000, 30000, 45000],
                        borderColor: '#D70F64', backgroundColor: 'rgba(215, 15, 100, 0.1)', fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        });
    </script>
</body>

</html>