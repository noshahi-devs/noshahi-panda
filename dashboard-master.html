<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control | Noshahi Panda Enterprise</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --brand-red: #D70F64;
            --brand-dark: #0f172a;
            --sidebar-width: 280px;
            --premium-gray: #f8fafc;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f1f5f9;
            overflow-x: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--brand-dark);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            padding: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2.5rem;
            min-height: 100vh;
        }

        .nav-link-master {
            color: rgba(255, 255, 255, 0.6);
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .nav-link-master:hover,
        .nav-link-master.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link-master.active {
            background: var(--brand-red);
            box-shadow: 0 4px 15px rgba(215, 15, 100, 0.3);
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .stat-card:hover {
            transform: translateY(-8px);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        /* Tables */
        .premium-table-container {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }

        .table thead th {
            background: var(--premium-gray);
            border-bottom: none;
            padding: 1.2rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .table tbody td {
            padding: 1.2rem 1.5rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Balance Card (Corporate) */
        .balance-hero {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            border-radius: 30px;
            padding: 3rem;
            position: relative;
            overflow: hidden;
            margin-bottom: 2.5rem;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
        }

        .balance-hero::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(215, 15, 100, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        /* Reviews */
        .review-bubble {
            background: white;
            border-radius: 18px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-left: 5px solid var(--brand-red);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
        }

        /* Section Container */
        .dashboard-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .dashboard-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .badge-premium {
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .nav-category {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.3);
            margin: 1.5rem 0 0.8rem 1.2rem;
            font-weight: 700;
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-brand-red p-2 rounded-3 me-3" style="background: var(--brand-red)">
                <i class="fa-solid fa-crown fa-lg text-white"></i>
            </div>
            <div>
                <span class="h5 fw-bold mb-0 d-block">Panda Master</span>
                <span class="small text-white-50">Enterprise Suite</span>
            </div>
        </div>

        <nav class="flex-grow-1 overflow-auto">
            <div class="nav-category">Business Insight</div>
            <button class="nav-link-master active" data-section="section-analytics">
                <i class="fa-solid fa-chart-line"></i> Analytics View
            </button>
            <button class="nav-link-master" data-section="section-reviews">
                <i class="fa-solid fa-star"></i> Customer Reviews
            </button>
            <button class="nav-link-master" data-section="section-transactions">
                <i class="fa-solid fa-receipt"></i> Transactions
            </button>

            <div class="nav-category">Operations</div>
            <button class="nav-link-master" data-section="section-corporate">
                <i class="fa-solid fa-building-circle-check"></i> Corporate Portal
            </button>
            <button class="nav-link-master" data-section="section-partners">
                <i class="fa-solid fa-handshake"></i> Partner Hub
            </button>
            <button class="nav-link-master" data-section="section-fleet">
                <i class="fa-solid fa-motorcycle"></i> Fleet Management
            </button>

            <div class="nav-category">Financials</div>
            <button class="nav-link-master" data-section="section-billing">
                <i class="fa-solid fa-file-invoice-dollar"></i> Billing & Invoices
            </button>
        </nav>

        <div class="mt-auto pt-4 border-top border-secondary border-opacity-25">
            <div class="p-3 bg-white bg-opacity-5 rounded-4 mb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-success rounded-circle" style="width: 10px; height: 10px;"></div>
                    <span class="small fw-medium">All Systems Operational</span>
                </div>
            </div>
            <a href="index.html" class="nav-link-master text-danger">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Exit Master Suite
            </a>
        </div>
    </aside>

    <main class="main-content">
        <!-- TOP NAVBAR -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1" id="section-title">Analytics View</h2>
                <p class="text-muted mb-0" id="current-date-full">February 11, 2026 • Welcome back, CEO</p>
            </div>
            <div class="d-flex gap-3">
                <div class="dropdown">
                    <button class="btn btn-white border shadow-sm rounded-pill px-4 d-flex align-items-center gap-2"
                        data-bs-toggle="dropdown">
                        <i class="fa-solid fa-bell text-brand-red"></i>
                        <span class="badge bg-danger rounded-circle p-1" style="font-size: 0.5rem;">3</span>
                    </button>
                </div>
                <button class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm" onclick="location.reload()">
                    <i class="fa-solid fa-sync me-2"></i> Refresh
                </button>
            </div>
        </header>

        <!-- SECTION: ANALYTICS (Panda Admin Merge) -->
        <section id="section-analytics" class="dashboard-section active">
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-primary bg-opacity-10 text-primary"><i
                                    class="fa-solid fa-coins"></i></div>
                            <span class="text-success small fw-bold">+15.4% <i class="fa-solid fa-caret-up"></i></span>
                        </div>
                        <h3 class="fw-bold mb-1" id="master-revenue">Rs. 0</h3>
                        <p class="text-muted small mb-0">Platform Volumne</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-danger bg-opacity-10 text-danger"><i
                                    class="fa-solid fa-utensils"></i></div>
                            <span class="text-muted small">84 Active</span>
                        </div>
                        <h3 class="fw-bold mb-1" id="master-restaurants">0</h3>
                        <p class="text-muted small mb-0">Total Restaurants</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-warning bg-opacity-10 text-warning"><i class="fa-solid fa-star"></i>
                            </div>
                            <span class="text-info small fw-bold">4.9 Global</span>
                        </div>
                        <h3 class="fw-bold mb-1" id="master-reviews-count">0</h3>
                        <p class="text-muted small mb-0">User Feedbacks</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="icon-box bg-success bg-opacity-10 text-success"><i
                                    class="fa-solid fa-building"></i></div>
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill">Premium</span>
                        </div>
                        <h3 class="fw-bold mb-1" id="master-corps">12</h3>
                        <p class="text-muted small mb-0">Corporate Clients</p>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="premium-table-container p-4" style="height: 450px;">
                        <h5 class="fw-bold mb-4">Master Growth Index</h5>
                        <canvas id="masterRevenueChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="premium-table-container p-4" style="height: 450px;">
                        <h5 class="fw-bold mb-4">Market Share</h5>
                        <canvas id="marketShareChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: CORPORATE PORTAL (Panda Corporate Merge) -->
        <section id="section-corporate" class="dashboard-section">
            <div class="balance-hero shadow-lg">
                <div class="row align-items-center">
                    <div class="col-lg-7">
                        <h6 class="text-white-50 text-uppercase fw-bold mb-3 small">Enterprise Credit Reserve</h6>
                        <h1 class="display-3 fw-bold mb-4">Rs. 8,240,000</h1>
                        <p class="text-white-50 mb-4 pe-lg-5">Centralized billing for all registered corporate partners
                            including Google, Microsoft, and local enterprise clients.</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-brand-red px-4 py-2 fw-bold rounded-pill">Manage Allocations</button>
                            <button class="btn btn-outline-light px-4 py-2 fw-bold rounded-pill">Detailed Audit</button>
                        </div>
                    </div>
                    <div class="col-lg-5 text-end d-none d-lg-block">
                        <i class="fa-solid fa-building-shield fa-10x opacity-10"></i>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted small mb-3">Group Orders Today</h6>
                        <h4 class="fw-bold">42 Active Bulks</h4>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-brand-red" style="width: 65%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted small mb-3">Employee Meal Vouchers</h6>
                        <h4 class="fw-bold">1,420 Redeemed</h4>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: 80%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted small mb-3">Corporate Savings</h6>
                        <h4 class="fw-bold text-success">Rs. 124k Today</h4>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: PARTNER HUB (Unified Management) -->
        <section id="section-partners" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Restaurant Partnerships</h4>
                <button class="btn btn-brand-red rounded-pill px-4 fw-bold" data-bs-toggle="modal"
                    data-bs-target="#addResModal">
                    <i class="fa-solid fa-plus me-2"></i> Onboard New Kitchen
                </button>
            </div>
            <div class="premium-table-container">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Restaurant</th>
                                <th>Cuisine</th>
                                <th>Onboarding</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="master-partner-list">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION: FLEET MANAGEMENT -->
        <section id="section-fleet" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Rider Fleet Logistics</h4>
                <button class="btn btn-dark rounded-pill px-4 fw-bold" data-bs-toggle="modal"
                    data-bs-target="#addRiderModal">
                    <i class="fa-solid fa-person-biking me-2"></i> Hire New Logistics Partner
                </button>
            </div>
            <div class="premium-table-container">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Rider Profile</th>
                                <th>Vehicle</th>
                                <th>Avg. Rating</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Manage</th>
                            </tr>
                        </thead>
                        <tbody id="master-fleet-list">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION: REVIEWS -->
        <section id="section-reviews" class="dashboard-section">
            <h4 class="fw-bold mb-4">Customer Experience Audit</h4>
            <div class="row g-4" id="master-reviews-grid">
                <!-- Dynamic Content -->
                <div class="col-12 text-center py-5 text-muted">No feedback received yet</div>
            </div>
        </section>

        <!-- SECTION: TRANSACTIONS -->
        <section id="section-transactions" class="dashboard-section">
            <h4 class="fw-bold mb-4">Live Transaction Ledger</h4>
            <div class="premium-table-container">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Transaction ID</th>
                                <th>Entity</th>
                                <th>Date/Time</th>
                                <th>Total Amount</th>
                                <th class="text-end pe-4">Gateway Status</th>
                            </tr>
                        </thead>
                        <tbody id="master-transaction-list">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION: BILLING -->
        <section id="section-billing" class="dashboard-section">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="premium-table-container p-4">
                        <h5 class="fw-bold mb-4">Recent Invoices</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ref ID</th>
                                    <th>Client</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th class="text-end">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#INV-MASTER-001</td>
                                    <td>Google INC</td>
                                    <td>Feb 28, 2026</td>
                                    <td class="fw-bold">Rs. 420,000</td>
                                    <td class="text-end"><span
                                            class="badge bg-warning bg-opacity-10 text-warning px-3 rounded-pill">Pending</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#INV-MASTER-002</td>
                                    <td>The Burger Club</td>
                                    <td>Feb 15, 2026</td>
                                    <td class="fw-bold">Rs. 85,000</td>
                                    <td class="text-end"><span
                                            class="badge bg-success bg-opacity-10 text-success px-3 rounded-pill">Settled</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="stat-card h-100">
                        <h5 class="fw-bold mb-4">Payout Schedule</h5>
                        <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                            <span class="text-muted">Riders Weekly</span>
                            <span class="fw-bold">Rs. 450k</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                            <span class="text-muted">Restaurants Net</span>
                            <span class="fw-bold">Rs. 1.2M</span>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-brand-red w-100 py-3 fw-bold rounded-3">Initialize All
                                Payouts</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALS (Merged from both dashboards) -->
    <!-- Profile Detail Modal -->
    <div class="modal fade" id="masterProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="master-profile-title">Profile Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="master-profile-details"></div>
            </div>
        </div>
    </div>

    <!-- Add Restaurant Modal -->
    <div class="modal fade" id="addResModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="bg-brand-red p-4 text-white">
                    <h5 class="fw-bold mb-0">Onboard New Restaurant</h5>
                    <p class="small opacity-75 mb-0">Register a new kitchen to the Panda Network</p>
                </div>
                <form id="master-add-res-form" class="p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small fw-bold">Restaurant Name</label>
                            <input type="text" class="form-control" name="resName" required placeholder="Gourmet Grill">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Owner Name</label>
                            <input type="text" class="form-control" name="ownerName" required placeholder="Ahamed">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email</label>
                            <input type="email" class="form-control" name="email" required
                                placeholder="info@gourmet.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold">Cuisine Speciality</label>
                            <select class="form-select" name="cuisine" required>
                                <option value="Fast Food">Fast Food</option>
                                <option value="Desi">Desi</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Italian">Italian</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-brand-red rounded-pill px-4 fw-bold">Register
                            Partner</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Rider Modal -->
    <div class="modal fade" id="addRiderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="bg-dark p-4 text-white">
                    <h5 class="fw-bold mb-0">Contract New Rider</h5>
                    <p class="small opacity-75 mb-0">Expand your logistics reach</p>
                </div>
                <form id="master-add-rider-form" class="p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small fw-bold">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Contact Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">City Branch</label>
                            <input type="text" class="form-control" name="city" required value="Lahore">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Logistics Mode</label>
                            <select class="form-select" name="vehicle" required>
                                <option value="Motorbike">Heavy Motorbike</option>
                                <option value="Car">Delivery Van/Car</option>
                                <option value="Bicycle">Eco-Friendly Cycle</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Base Monthly Remuneration</label>
                            <input type="number" class="form-control" name="salary" required value="35000">
                        </div>
                    </div>
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-dark rounded-pill px-4 fw-bold">Sign Contract</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Date
            document.getElementById('current-date-full').innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' • Master Pulse';

            // NAVIGATION LOGIC
            const navButtons = document.querySelectorAll('.nav-link-master');
            const sections = document.querySelectorAll('.dashboard-section');
            const secTitle = document.getElementById('section-title');

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-section');
                    const title = btn.innerText.trim();

                    // Update Sidebar
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Update Title
                    secTitle.innerText = title;

                    // Switch Sections
                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(target).classList.add('active');

                    // Trigger Data Refresh for specific sections
                    refreshSectionData(target);
                });
            });

            // DATA LOADING & RENDERING
            function refreshSectionData(sectionId) {
                const reviews = JSON.parse(localStorage.getItem('noshahi_reviews') || '[]');
                const sales = JSON.parse(localStorage.getItem('noshahi_sales_data') || '[]');
                const restaurants = JSON.parse(localStorage.getItem('noshahi_all_restaurants') || '[]');
                const riders = JSON.parse(localStorage.getItem('noshahi_all_riders') || '[]');

                // Global Stats Calculation
                const totalRev = sales.reduce((acc, sale) => acc + sale.amount, 0);
                document.getElementById('master-revenue').innerText = `Rs. ${totalRev.toLocaleString()}`;
                document.getElementById('master-restaurants').innerText = restaurants.length;
                document.getElementById('master-reviews-count').innerText = reviews.length;

                if (sectionId === 'section-partners') renderPartners(restaurants);
                if (sectionId === 'section-fleet') renderFleet(riders);
                if (sectionId === 'section-reviews') renderReviews(reviews);
                if (sectionId === 'section-transactions') renderTransactions(sales);
            }

            function renderPartners(data) {
                const list = document.getElementById('master-partner-list');
                list.innerHTML = data.slice().reverse().map((res, i) => {
                    const idx = data.length - 1 - i;
                    const statusClass = res.status === 'Active' ? 'text-success bg-success' : 'text-warning bg-warning';
                    return `
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-light rounded-circle p-2"><i class="fa-solid fa-utensils text-dark"></i></div>
                                    <div><div class="fw-bold">${res.name}</div><div class="small text-muted">${res.owner}</div></div>
                                </div>
                            </td>
                            <td>${res.cuisine}</td>
                            <td><div class="small">${res.date || 'Legacy'}</div></td>
                            <td><span class="badge ${statusClass} bg-opacity-10 rounded-pill px-3">${res.status || 'Active'}</span></td>
                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary border-0" onclick="viewMasterProfile('restaurant', ${idx})"><i class="fa-solid fa-eye"></i></button>
                                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteMasterEntry('restaurant', ${idx})"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function renderFleet(data) {
                const list = document.getElementById('master-fleet-list');
                list.innerHTML = data.slice().reverse().map((rider, i) => {
                    const idx = data.length - 1 - i;
                    return `
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-dark rounded-circle p-2 text-white"><i class="fa-solid fa-user"></i></div>
                                    <div><div class="fw-bold">${rider.name}</div><div class="small text-muted">${rider.email}</div></div>
                                </div>
                            </td>
                            <td><div class="small fw-bold">${rider.vehicle}</div></td>
                            <td><i class="fa-solid fa-star text-warning me-1"></i>${rider.rating || '5.0'}</td>
                            <td><span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">${rider.status || 'Active'}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-light border-0" onclick="viewMasterProfile('rider', ${idx})"><i class="fa-solid fa-gear"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function renderReviews(data) {
                const grid = document.getElementById('master-reviews-grid');
                if (data.length === 0) return;
                grid.innerHTML = data.slice().reverse().map(rev => `
                    <div class="col-md-4">
                        <div class="review-bubble h-100">
                            <div class="d-flex justify-content-between mb-3 align-items-start">
                                <div class="fw-bold small">Order #${rev.orderId || 'NP-000'}<br><span class="text-muted fw-normal">${rev.restaurantName || 'General'}</span></div>
                                <div class="text-warning small">${Array(rev.rating).fill('<i class="fa-solid fa-star"></i>').join('')}</div>
                            </div>
                            <p class="small text-dark mb-0 fst-italic">"${rev.comment || 'Safe and sound!'}"</p>
                            <div class="mt-3 text-end small text-muted">${rev.date}</div>
                        </div>
                    </div>
                `).join('');
            }

            function renderTransactions(data) {
                const list = document.getElementById('master-transaction-list');
                list.innerHTML = data.slice().reverse().map(sale => `
                    <tr>
                        <td class="ps-4 fw-bold text-muted">#TX-${sale.id.toString().slice(-6)}</td>
                        <td><span class="fw-bold">${sale.restaurant}</span></td>
                        <td>${new Date(sale.date).toLocaleString()}</td>
                        <td class="fw-bold text-brand-red">Rs. ${sale.amount.toLocaleString()}</td>
                        <td class="text-end pe-4"><span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Verified</span></td>
                    </tr>
                `).join('');
            }

            // PROFILE MODAL LOGIC (UNIFIED)
            window.viewMasterProfile = (type, index) => {
                const key = type === 'restaurant' ? 'noshahi_all_restaurants' : 'noshahi_all_riders';
                const data = JSON.parse(localStorage.getItem(key));
                const p = data[index];
                const content = document.getElementById('master-profile-details');

                document.getElementById('master-profile-title').innerText = `${type.toUpperCase()} MASTER RECORD`;

                content.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="bg-light rounded-circle d-inline-flex p-4 mb-3 border">
                            <i class="fa-solid fa-${type === 'restaurant' ? 'utensils' : 'user'} fa-3x"></i>
                        </div>
                        <h4 class="fw-bold">${p.name}</h4>
                        <span class="badge bg-dark rounded-pill px-4">${p.status || 'Active'}</span>
                    </div>
                    <div class="row g-3">
                        <div class="col-6"><label class="small text-muted d-block">Main Contact</label><strong>${p.owner || p.name}</strong></div>
                        <div class="col-6"><label class="small text-muted d-block">Email</label><small>${p.email}</small></div>
                        <div class="col-6"><label class="small text-muted d-block">Operational Basis</label><strong>${p.cuisine || p.vehicle}</strong></div>
                        <div class="col-6"><label class="small text-muted d-block">Start Date</label><strong>${p.date || 'Pre-System'}</strong></div>
                        ${type === 'rider' ? `<div class="col-12"><label class="small text-muted d-block">Base Salary</label><strong class="h4 text-success">Rs. ${p.salary.toLocaleString()}</strong></div>` : ''}
                    </div>
                    <div class="mt-4 pt-3 border-top">
                        <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="toggleMasterStatus('${type}', ${index})">Toggle Active/Suspended</button>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('masterProfileModal')).show();
            };

            window.deleteMasterEntry = (type, index) => {
                if (confirm('Permanently remove this partner from Enterprise Grid?')) {
                    const key = type === 'restaurant' ? 'noshahi_all_restaurants' : 'noshahi_all_riders';
                    let data = JSON.parse(localStorage.getItem(key));
                    data.splice(index, 1);
                    localStorage.setItem(key, JSON.stringify(data));
                    refreshSectionData(`section-${type === 'restaurant' ? 'partners' : 'fleet'}`);
                }
            };

            window.toggleMasterStatus = (type, index) => {
                const key = type === 'restaurant' ? 'noshahi_all_restaurants' : 'noshahi_all_riders';
                let data = JSON.parse(localStorage.getItem(key));
                data[index].status = data[index].status === 'Active' ? 'Suspended' : 'Active';
                localStorage.setItem(key, JSON.stringify(data));
                location.reload();
            };

            // FORM HANDLERS
            document.getElementById('master-add-res-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const newData = {
                    name: fd.get('resName'),
                    owner: fd.get('ownerName'),
                    email: fd.get('email'),
                    cuisine: fd.get('cuisine'),
                    date: new Date().toLocaleDateString(),
                    status: 'Active'
                };
                let current = JSON.parse(localStorage.getItem('noshahi_all_restaurants') || '[]');
                current.push(newData);
                localStorage.setItem('noshahi_all_restaurants', JSON.stringify(current));
                location.reload();
            });

            document.getElementById('master-add-rider-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const newData = {
                    name: fd.get('name'),
                    email: fd.get('email'),
                    city: fd.get('city'),
                    vehicle: fd.get('vehicle'),
                    salary: parseInt(fd.get('salary')),
                    rating: 5.0,
                    date: new Date().toLocaleDateString(),
                    status: 'Active'
                };
                let current = JSON.parse(localStorage.getItem('noshahi_all_riders') || '[]');
                current.push(newData);
                localStorage.setItem('noshahi_all_riders', JSON.stringify(current));
                location.reload();
            });

            // ANALYTICS CHARTS
            function initCharts() {
                // Revenue Chart
                const revCtx = document.getElementById('masterRevenueChart').getContext('2d');
                new Chart(revCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Platform Net (Rs)',
                            data: [65000, 82000, 75000, 110000, 145000, 210000, 280000],
                            borderColor: '#D70F64',
                            backgroundColor: 'rgba(215, 15, 100, 0.05)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 4,
                            pointRadius: 6,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#D70F64',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { display: true, grid: { color: '#f1f5f9' }, border: { dash: [5, 5] } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                // Market Share Chart
                const mktCtx = document.getElementById('marketShareChart').getContext('2d');
                new Chart(mktCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Fast Food', 'Desi', 'Chinese', 'Others'],
                        datasets: [{
                            data: [45, 30, 15, 10],
                            backgroundColor: ['#D70F64', '#0f172a', '#3b82f6', '#94a3b8'],
                            borderWidth: 0,
                            cutout: '75%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6, font: { size: 10 } } } }
                    }
                });
            }

            // Initial Load
            refreshSectionData('section-analytics');
            initCharts();
        });
    </script>
</body>

</html>