<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Noshahi Panda</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-light">

    <!-- Simple Navbar for Checkout -->
    <nav class="navbar navbar-light bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="brand-logo me-2">
                    <span class="logo-n">N</span>
                </div>
                <span class="brand-text fw-bold"><span class="text-orange">Noshahi</span> <span
                        class="text-dark">Panda</span></span>
            </a>
            <span class="fw-bold">Secured Checkout</span>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row g-5">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0"><i class="fa-solid fa-location-dot text-brand-red me-2"></i> Delivery
                            Address</h4>
                        <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3"
                            onclick="detectLocation()" id="locationBtn">
                            <i class="fa-solid fa-crosshairs me-1"></i> Detect My Location
                        </button>
                    </div>
                    <form id="addressForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label small fw-bold">Street Address</label>
                                <input type="text" id="streetAddress" class="form-control bg-light border-0"
                                    placeholder="e.g. House #123, Street 5, Phase 6">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">City</label>
                                <input type="text" id="city" class="form-control bg-light border-0"
                                    placeholder="Lahore">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Floor / Apartment (Optional)</label>
                                <input type="text" id="floor" class="form-control bg-light border-0"
                                    placeholder="3rd Floor">
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <h4 class="fw-bold mb-4"><i class="fa-solid fa-credit-card text-brand-red me-2"></i> Payment Method
                    </h4>
                    <div class="d-flex flex-column gap-3">
                        <div class="p-3 border rounded-3 d-flex align-items-center pointer active-payment">
                            <input type="radio" name="payment" id="cod" checked class="me-3">
                            <label for="cod" class="d-flex align-items-center flex-grow-1 pointer">
                                <i class="fa-solid fa-money-bill-1-wave me-3 text-success fa-lg"></i>
                                <div>
                                    <div class="fw-bold">Cash on Delivery</div>
                                    <div class="small text-muted">Pay at your doorstep</div>
                                </div>
                            </label>
                        </div>
                        <div class="p-3 border rounded-3 d-flex align-items-center pointer">
                            <input type="radio" name="payment" id="card" class="me-3">
                            <label for="card" class="d-flex align-items-center flex-grow-1">
                                <i class="fa-solid fa-credit-card me-3 text-primary fa-lg"></i>
                                <div>
                                    <div class="fw-bold">Credit/Debit Card</div>
                                    <div class="small text-muted">Visa, Mastercard, etc. (Coming Soon)</div>
                                </div>
                            </label>
                        </div>
                        <!-- JazzCash -->
                        <div class="p-3 border rounded-3 d-flex align-items-center pointer">
                            <input type="radio" name="payment" id="jazzcash" class="me-3">
                            <label for="jazzcash" class="d-flex align-items-center flex-grow-1 pointer">
                                <div class="bg-white p-1 rounded-2 me-3"
                                    style="width: 50px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05)">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/JazzCash_logo.png/256px-JazzCash_logo.png"
                                        style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                </div>
                                <div>
                                    <div class="fw-bold">JazzCash</div>
                                    <div class="small text-muted">Pay securely with your JazzCash account</div>
                                </div>
                            </label>
                        </div>

                        <!-- EasyPaisa -->
                        <div class="p-3 border rounded-3 d-flex align-items-center pointer">
                            <input type="radio" name="payment" id="easypaisa" class="me-3">
                            <label for="easypaisa" class="d-flex align-items-center flex-grow-1 pointer">
                                <div class="bg-white p-1 rounded-2 me-3"
                                    style="width: 50px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05)">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Easypaisa_logo.png/256px-Easypaisa_logo.png"
                                        style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                </div>
                                <div>
                                    <div class="fw-bold">EasyPaisa</div>
                                    <div class="small text-muted">Pay securely with your EasyPaisa account</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 sticky-top" style="top: 100px;">
                    <h4 class="fw-bold mb-4">Order Summary</h4>
                    <div id="checkout-items" class="mb-4">
                        <!-- Items populated from LocalStorage -->
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span id="checkout-subtotal" class="fw-bold">Rs. 0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Delivery Fee</span>
                        <span class="text-success fw-bold">Rs. 99</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold h5">Total</span>
                        <span id="checkout-total" class="fw-bold h5 text-brand-red">Rs. 0</span>
                    </div>

                    <button class="btn btn-brand-red w-100 py-3 fw-bold rounded-3 h5 mb-0" onclick="placeOrder()">Place
                        Order</button>
                    <p class="text-center small text-muted mt-3 mb-0">By placing this order, you agree to our Terms.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div class="modal fade" id="successModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 p-4">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fa-solid fa-circle-check text-success fa-5x"></i>
                    </div>
                    <h3 class="fw-bold">Order Placed Successfully!</h3>
                    <p class="text-muted">Thank you for ordering with Noshahi Panda. Your food is on its way!</p>
                    <div class="d-flex flex-column gap-2 mt-3">
                        <button class="btn btn-brand-red py-3 rounded-3 fw-bold h5 mb-0"
                            onclick="window.location.href='order-confirmed.html'">
                            <i class="fa-solid fa-map-location-dot me-2"></i> Track My Order
                        </button>
                        <button class="btn btn-link text-muted text-decoration-none small"
                            onclick="window.location.href='index.html'">Go to Homepage</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Basic checkout logic
        document.addEventListener('DOMContentLoaded', () => {
            const cartItems = JSON.parse(localStorage.getItem('pandaCart') || '[]');
            const container = document.getElementById('checkout-items');
            let subtotal = 0;

            if (cartItems.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">Your cart is empty</p>';
                document.querySelector('button[onclick="placeOrder()"]').disabled = true;
            } else {
                container.innerHTML = '';
                cartItems.forEach(item => {
                    const price = parseInt(item.price.replace(/[^\d]/g, ''));
                    subtotal += price * item.quantity;

                    container.innerHTML += `
                        <div class="d-flex justify-content-between mb-3 align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-3 p-1 me-3 text-center" style="width:30px">${item.quantity}x</div>
                                <div>
                                    <div class="fw-bold small">${item.name}</div>
                                    <div class="text-muted" style="font-size:0.75rem">${item.restaurant}</div>
                                </div>
                            </div>
                            <span class="small fw-bold">Rs. ${price * item.quantity}</span>
                        </div>
                    `;
                });
            }

            document.getElementById('checkout-subtotal').innerText = `Rs. ${subtotal || 0}`;
            document.getElementById('checkout-total').innerText = `Rs. ${subtotal ? subtotal + 99 : 0}`;

            // Auto-detect location on load
            detectLocation();
        });

        function detectLocation() {
            const btn = document.getElementById('locationBtn');
            const originalContent = btn.innerHTML;

            if (!navigator.geolocation) {
                Swal.fire({
                    icon: 'error',
                    title: 'Not Supported',
                    text: 'Geolocation is not supported by your browser',
                    confirmButtonColor: '#E53935'
                });
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Locating...';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;

                    try {
                        // Use OpenStreetMap Nominatim for free reverse geocoding
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);
                        const data = await response.json();

                        if (data && data.address) {
                            const addr = data.address;
                            // Construct a friendly street address
                            const street = addr.road || addr.suburb || addr.neighbourhood || "";
                            const house = addr.house_number || "";

                            document.getElementById('streetAddress').value = `${house ? house + ', ' : ''}${street}`;
                            document.getElementById('city').value = addr.city || addr.town || addr.village || "Lahore";

                            btn.innerHTML = '<i class="fa-solid fa-check me-1"></i> Location Confirmed';
                            btn.classList.replace('btn-outline-danger', 'btn-success');
                        }
                    } catch (error) {
                        console.error("Error reverse geocoding:", error);
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                        Swal.fire({
                            icon: 'warning',
                            title: 'Detection Failed',
                            text: 'Could not fetch address details. Please enter manually.',
                            confirmButtonColor: '#E53935'
                        });
                    }
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    Swal.fire({
                        icon: 'error',
                        title: 'Permission Denied',
                        text: 'Unable to retrieve your location. Check your browser permissions.',
                        confirmButtonColor: '#E53935'
                    });
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function placeOrder() {
            // Get selected payment method
            const paymentMethod = document.querySelector('input[name="payment"]:checked').id;
            const cartItems = JSON.parse(localStorage.getItem('pandaCart') || '[]');
            const total = document.getElementById('checkout-total').innerText;

            // Save active order info for tracking and reviews
            const activeOrder = {
                id: Math.floor(1000 + Math.random() * 9000),
                restaurant: cartItems[0] ? cartItems[0].restaurant : 'Unknown',
                items: cartItems,
                customer: "Guest User",
                total: total,
                date: new Date().toLocaleString(),
                method: paymentMethod,
                status: 'Preparing',
                address: `${document.getElementById('streetAddress').value}, ${document.getElementById('city').value}`
            };
            localStorage.setItem('noshahi_active_order', JSON.stringify({ ...activeOrder, status: 'active' }));

            // Add to master orders list for Seller Dashboard
            let allOrders = JSON.parse(localStorage.getItem('noshahi_all_orders') || '[]');
            allOrders.unshift(activeOrder);
            localStorage.setItem('noshahi_all_orders', JSON.stringify(allOrders));

            if (paymentMethod === 'cod') {
                const modalElem = document.getElementById('successModal');
                const modal = new bootstrap.Modal(modalElem);
                modal.show();
                localStorage.removeItem('pandaCart');

                // Redirect to tracking after 3 seconds
                setTimeout(() => {
                    window.location.href = 'order-confirmed.html';
                }, 3000);
            } else if (paymentMethod === 'jazzcash') {
                window.location.href = 'payment-jazzcash.html';
            } else if (paymentMethod === 'easypaisa') {
                window.location.href = 'payment-easypaisa.html';
            } else if (paymentMethod === 'card') {
                window.location.href = 'payment-card.html';
            }
        }
    </script>
</body>

</html>